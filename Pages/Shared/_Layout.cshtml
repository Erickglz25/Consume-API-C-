<!DOCTYPE html>
<html>
<head>
    <!--Import Google Icon Font-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
          rel="stylesheet" />
    <!--Import materialize.css-->
    <link type="text/css"
          rel="stylesheet"
          href="~/vendor/materialize/css/materialize.min.css"
          media="screen,projection" />

    <link type="text/css"
          rel="stylesheet"
          href="~/css/custom.css"
          media="screen,projection" />

    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>API Envios</title>
</head>
<body>

    @RenderBody()

    <!--JavaScript at end of body for optimized loading-->
    <script type="text/javascript"
            src="~/vendor/jQuery/jquery.3.3.1.js"></script>
    <script type="text/javascript"
            src="~/vendor/materialize/js/materialize.min.js"></script>
    <script type="text/javascript"
            src="~/vendor/jquery.validate/jquery.validate.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script>

        $(document).ready(function () {

            $("textarea#textarea1").characterCounter();
            $("select").formSelect();
            $(".tabs").tabs();

        });

        $(document).on("click", "li a", function() {
            if ($(this).hasClass("active")) {
            $("#regform")
                .get()[0]
                .reset();
            $("#valform")
                .get()[0]
                .reset();
            }
        });

        $("#tokenform").validate({
            rules: {
            api: {
                required: true
            }
            },
            messages: {
            api: {
                required: "Requerido"
            }
            },
            errorElement: "span",
            errorPlacement: function(error, element) {
            var placement = $(element).data("error");
            if (placement) {
                $(placement).append(error);
            } else {
                error.insertAfter(element);
            }
            },
            submitHandler: function () {

            let this_key = $("#api").val()

            $.ajax({

                url: "@Html.Raw(@Url.Action("Auth", "sms", new { @action_cmd = "auth", @api_key = "_Key" }))".replace("_Key",this_key),
                method: "post",
                success: res => {
                    
                res = JSON.parse(res);
                if (res.code != "auth_02") {
                    swal({
                    title: "Mensaje",
                    text: res.message,
                    icon: "info"
                    });
                    return;
                }

                $("#token").val(res.token);
                $("#token")
                    .parent()
                    .find("label")
                    .addClass("active");
                swal({
                    title: "Mensaje",
                    text: res.message,
                    icon: "info"
                });
                }
            });
            }
        });

        $("#request_credits").on("click", e => {
          $(e.currentTarget).addClass("disabled");
            var token = $("#token").val();

          
          if ( token.trim() == "") {
            swal({
            title: "Advertencia",
            text:
                "Debes introducir tu ApiKey y generar un token para poder enviar mensajes",
            icon: "warning"
            });
              $("#request_credits").removeClass("disabled");
            return;
          }

          $.ajax({
            url: "@Html.Raw(@Url.Action("Credits", "sms", new { @action_cmd = "credits",@token = "_Token"}))".replace("_Token", token),
            type: "POST",
              success: res => {
               
              res = JSON.parse(res);
              $("#request_credits").removeClass("disabled");
              if (res[0] == 1) {
                $("#apiform")
                  .get()[0]
                  .reset();
                swal({
                  title: "Total de cr\u00E9ditos",
                  text: "Cr\u00E9ditos disponibles:  " + res[1],
                  icon: "info"
                });
              } else {
                $("#apiform")
                  .get()[0]
                  .reset();
                swal({
                  title: "Mensaje",
                  text: res[1],
                  icon: "warning"
                });
              }
            }
          });
        });

        $("#apiform").validate({
            rules: {
            destination: {
                required: true,
                minlength: 10
            },
            content: {
                required: true,
                maxlength: 160
            }
            },
            messages: {
            destination: {
                required: "Requerido",
                minlength: "M\u00EDnimo 10 d\u00EDgitos"
            },
            content: {
                required: "Requerido",
                maxlength: "No puede exceder 160 caracteres"
            }
            },
            errorElement: "span",
            errorPlacement: function(error, element) {
            var placement = $(element).data("error");
            if (placement) {
                $(placement).append(error);
            } else {
                error.insertAfter(element);
            }
            },
            submitHandler: function() {
            var api = $("#api").val();
            var token = $("#token").val();
            var nombre = $("#nombre").val();
            var sandbox = "";

            if ($("#sandbox:checked").length) {
                sandbox = 1;
            } else {
                sandbox = 0;
            }

            if (api.trim() == "" || token.trim() == "") {
                swal({
                title: "Advertencia",
                text:
                    "Debes introducir tu ApiKey y generar un token para poder enviar mensajes",
                icon: "warning"
                });
                return;
            }

            let this_c = $("#country option:selected").text();
            let this_dest = $("#destination").val();
            let this_texto = $("#textarea1").val();

                
            $.ajax({

                url: "@Html.Raw(@Url.Action("Send", "sms", new { @action_cmd = "send", @token = "_Token" ,@c = "_Country", @dest = "_Destination", @texto = "_Texto", @sand= "_Sandbox", @nombre = "_Nombre"}))".replace("_Country", this_c).replace("_Destination", this_dest).replace("_Texto", this_texto).replace("_Sandbox", sandbox).replace("_Nombre", nombre).replace("_Token", token),
                method: "post",
                success: res => {

                    res = JSON.parse(res);
                        
                $("#apiform")
                    .get()[0]
                    .reset();

                swal({
                    title: "Mensaje",
                    text: res.message,
                    icon: "info"
                });
                }

            });
            }
        });



    </script>
</body>
</html>
